<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç–∞—Ç—å–∏</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #2c3e50;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        input[type="text"],
        textarea,
        select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        input[type="text"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .preview-section {
            margin-top: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #e9ecef;
        }

        .preview-section h3 {
            margin-bottom: 15px;
            color: #495057;
        }

        .preview-content {
            max-height: 500px;
            overflow-y: auto;
            padding: 20px;
            background-color: white;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .preview-block {
            margin-bottom: 20px;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            /* –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤—ã—Å–æ—Ç–∞ */
            height: auto;
        }

        .text-preview {
            padding: 20px;
            line-height: 1.6;
            /* –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤—ã—Å–æ—Ç–∞ */
            height: auto;
            /* –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª–∏–Ω–Ω—ã—Ö —Å–ª–æ–≤ */
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            width: 100%;
        }

        .text-preview p {
            margin-bottom: 1em;
            word-wrap: break-word;
        }

        .text-preview b,
        .text-preview strong {
            font-weight: bold;
        }

        .text-preview i,
        .text-preview em {
            font-style: italic;
        }

        .text-preview u {
            text-decoration: underline;
        }

        .text-preview center {
            text-align: center;
            display: block;
        }

        .text-preview right {
            text-align: right;
            display: block;
        }

        .text-preview justify {
            text-align: justify;
            display: block;
        }

        .media-preview {
            text-align: center;
            padding: 20px;
            background-color: #e9ecef;
            border-radius: 4px;
            /* –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤—ã—Å–æ—Ç–∞ */
            height: auto;
        }

        .media-preview img,
        .media-preview video {
            max-width: 100%;
            max-height: 300px;
            border-radius: 4px;
        }

        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
            transition: background-color 0.2s;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #545b62;
        }

        .char-count {
            text-align: right;
            font-size: 14px;
            color: #6c757d;
            margin-top: 5px;
        }

        .blocks-info {
            background-color: #e7f3ff;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
            border-left: 4px solid #3498db;
        }

        .blocks-info h4 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .file-info {
            background-color: #d1ecf1;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            border-left: 4px solid #17a2b8;
        }

        .file-info h5 {
            margin-bottom: 5px;
            color: #0c5460;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –≤ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–µ */
        .formatted-preview {
            line-height: 1.6;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            width: 100%;
            /* –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤—ã—Å–æ—Ç–∞ */
            height: auto;
        }

        .formatted-preview p {
            margin-bottom: 1em;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .formatted-preview b,
        .formatted-preview strong {
            font-weight: bold;
        }

        .formatted-preview i,
        .formatted-preview em {
            font-style: italic;
        }

        .formatted-preview u {
            text-decoration: underline;
        }

        .formatted-preview center {
            text-align: center;
            display: block;
        }

        .formatted-preview right {
            text-align: right;
            display: block;
        }

        .formatted-preview justify {
            text-align: justify;
            display: block;
        }

        /* –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω—ã—Ö —Å–ª–æ–≤ */
        .formatted-preview {
            overflow-wrap: break-word;
            word-break: break-word;
        }

        .formatted-preview * {
            max-width: 100%;
            word-wrap: break-word;
        }

        .empty-preview {
            color: #6c757d;
            font-style: italic;
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>–°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç–∞—Ç—å–∏</h1>

    <form id="articleForm" enctype="multipart/form-data">
        <div class="form-group">
            <label for="title">–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç–∞—Ç—å–∏ *</label>
            <input type="text" id="title" name="title"
                   placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç–∞—Ç—å–∏" required maxlength="255">
            <div class="char-count"><span id="titleCount">0</span>/255</div>
        </div>

        <div class="form-group">
            <label for="shortDescription">–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ *</label>
            <textarea id="shortDescription" name="shortDescription"
                      placeholder="–í–≤–µ–¥–∏—Ç–µ –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å—Ç–∞—Ç—å–∏ (–º–∞–∫—Å–∏–º—É–º 500 —Å–∏–º–≤–æ–ª–æ–≤)"
                      required maxlength="500"></textarea>
            <div class="char-count"><span id="descCount">0</span>/500</div>
        </div>

        <div class="form-group">
            <div class="checkbox-group">
                <input type="checkbox" id="isPublished" name="isPublished">
                <label for="isPublished">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Å—Ç–∞—Ç—å—é —Å—Ä–∞–∑—É</label>
            </div>
        </div>

        <div class="blocks-info">
            <h4>üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–ª–æ–∫–∞—Ö</h4>
            <div id="blocksSummary">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –±–ª–æ–∫–∞—Ö...</div>
        </div>

        <div class="file-info">
            <h5>üìé –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–∞–π–ª–∞—Ö</h5>
            <div id="filesInfo">–§–∞–π–ª—ã —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏ –≥–æ—Ç–æ–≤—ã –∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—é</div>
        </div>

        <div class="preview-section">
            <h3>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–∞—Ç—å–∏</h3>
            <div id="contentPreview" class="preview-content">
                <!-- –ë–ª–æ–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
            </div>
        </div>

        <div class="button-group">
            <button type="button" class="btn btn-secondary" onclick="goBack()">‚Üê –ù–∞–∑–∞–¥ –∫ —Ä–µ–¥–∞–∫—Ç–æ—Ä—É</button>
            <button type="button" class="btn btn-primary" onclick="saveArticle()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–∞—Ç—å—é</button>
        </div>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –±–ª–æ–∫–∏ –∏–∑ sessionStorage
        const blocksJson = sessionStorage.getItem('articleBlocks');
        if (blocksJson) {
            const blocks = JSON.parse(blocksJson);
            displayPreview(blocks);
            updateBlocksSummary(blocks);
            updateFilesInfo(blocks);
        } else {
            alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –±–ª–æ–∫–∞—Ö —Å—Ç–∞—Ç—å–∏. –í–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä.');
            goBack();
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–æ–ª–µ–π —Ñ–æ—Ä–º—ã
        document.getElementById('title').addEventListener('input', function() {
            document.getElementById('titleCount').textContent = this.value.length;
        });

        document.getElementById('shortDescription').addEventListener('input', function() {
            document.getElementById('descCount').textContent = this.value.length;
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤
        document.getElementById('titleCount').textContent = document.getElementById('title').value.length;
        document.getElementById('descCount').textContent = document.getElementById('shortDescription').value.length;
    });

    function displayPreview(blocks) {
        const preview = document.getElementById('contentPreview');
        preview.innerHTML = '';

        if (blocks.length === 0) {
            preview.innerHTML = '<div class="empty-preview">–ù–µ—Ç –±–ª–æ–∫–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>';
            return;
        }

        blocks.forEach((block, index) => {
            const blockDiv = document.createElement('div');
            blockDiv.className = 'preview-block';

            let content = '';
            if (block.type === 'text') {
                content = `
                    <div class="text-preview formatted-preview">${block.content}</div>
                `;
            } else if (block.type === 'media') {
                // –î–ª—è –º–µ–¥–∏–∞-–±–ª–æ–∫–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ
                const isUploadedFile = block.content &&
                    (block.content.match(/\.(jpg|jpeg|png|gif|webp|mp4|webm|ogg|mov|mp3|wav)$/i) ||
                        block.content.length === 36 + 4); // UUID + extension

                if (isUploadedFile) {
                    content = `
                        <div class="media-preview">
                            <strong>–§–∞–π–ª:</strong> ${block.content}
                            <br><small style="color: #28a745;">‚úì –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä</small>
                        </div>
                    `;
                } else {
                    content = `
                        <div class="media-preview">
                            <strong>–§–∞–π–ª:</strong> ${block.content}
                        </div>
                    `;
                }
            }

            blockDiv.innerHTML = content;
            preview.appendChild(blockDiv);
        });

        // –ü—Ä–∏–º–µ–Ω—è–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é —Ä–µ–≥—É–ª–∏—Ä–æ–≤–∫—É –≤—ã—Å–æ—Ç—ã –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –±–ª–æ–∫–æ–≤
        setTimeout(() => {
            const textPreviews = preview.querySelectorAll('.text-preview');
            textPreviews.forEach(preview => {
                adjustPreviewHeight(preview);
            });
        }, 100);
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–≥—É–ª–∏—Ä–æ–≤–∫–∏ –≤—ã—Å–æ—Ç—ã —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –±–ª–æ–∫–æ–≤ –≤ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–µ
    function adjustPreviewHeight(element) {
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã—Å–æ—Ç—É
        element.style.height = 'auto';

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É —Ä–∞–≤–Ω—É—é scrollHeight
        const newHeight = element.scrollHeight;
        element.style.height = newHeight + 'px';

        // –ü—Ä–∏–º–µ–Ω—è–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–ª–∏–Ω–Ω—ã—Ö —Å–ª–æ–≤
        handleLongWordsInPreview(element);
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–ª–∏–Ω–Ω—ã—Ö —Å–ª–æ–≤ –≤ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–µ
    function handleLongWordsInPreview(element) {
        const text = element.innerText || element.textContent;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω—ã–µ —Å–ª–æ–≤–∞ (–±–æ–ª–µ–µ 30 —Å–∏–º–≤–æ–ª–æ–≤)
        const words = text.split(/\s+/);
        const veryLongWords = words.filter(word => word.length > 30);

        if (veryLongWords.length > 0) {
            console.log('–í –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã –æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω—ã–µ —Å–ª–æ–≤–∞:', veryLongWords);
            // CSS —É–∂–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —ç—Ç–æ —á–µ—Ä–µ–∑ word-break: break-word
        }
    }

    function updateBlocksSummary(blocks) {
        const summary = document.getElementById('blocksSummary');
        const textBlocks = blocks.filter(block => block.type === 'text').length;
        const mediaBlocks = blocks.filter(block => block.type === 'media').length;

        summary.innerHTML = `
            –í—Å–µ–≥–æ –±–ª–æ–∫–æ–≤: <strong>${blocks.length}</strong><br>
            –¢–µ–∫—Å—Ç–æ–≤—ã—Ö –±–ª–æ–∫–æ–≤: <strong>${textBlocks}</strong><br>
            –ú–µ–¥–∏–∞ –±–ª–æ–∫–æ–≤: <strong>${mediaBlocks}</strong>
        `;
    }

    function updateFilesInfo(blocks) {
        const filesInfo = document.getElementById('filesInfo');
        const mediaBlocks = blocks.filter(block => block.type === 'media');
        const uploadedFiles = mediaBlocks.filter(block =>
            block.content &&
            (block.content.match(/\.(jpg|jpeg|png|gif|webp|mp4|webm|ogg|mov|mp3|wav)$/i) ||
                block.content.length === 36 + 4) // UUID + extension
        );

        if (mediaBlocks.length === 0) {
            filesInfo.innerHTML = '–ú–µ–¥–∏–∞-—Ñ–∞–π–ª—ã –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã';
        } else if (uploadedFiles.length === mediaBlocks.length) {
            filesInfo.innerHTML = `
                –í—Å–µ —Ñ–∞–π–ª—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã: <strong>${uploadedFiles.length}</strong> –∏–∑ <strong>${mediaBlocks.length}</strong>
                <br><small style="color: #28a745;">‚úì –í—Å–µ —Ñ–∞–π–ª—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä</small>
            `;
        } else {
            filesInfo.innerHTML = `
                –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: <strong>${uploadedFiles.length}</strong> –∏–∑ <strong>${mediaBlocks.length}</strong>
                <br><small style="color: #dc3545;">‚ö† –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ñ–∞–π–ª—ã –º–æ–≥—É—Ç –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ</small>
            `;
        }
    }

    async function saveArticle() {
        const title = document.getElementById('title').value;
        const shortDescription = document.getElementById('shortDescription').value;
        const isPublished = document.getElementById('isPublished').checked;

        // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã
        if (!title.trim()) {
            alert('–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç–∞—Ç—å–∏');
            return;
        }

        if (!shortDescription.trim()) {
            alert('–í–≤–µ–¥–∏—Ç–µ –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å—Ç–∞—Ç—å–∏');
            return;
        }

        // –ü–æ–ª—É—á–∞–µ–º –±–ª–æ–∫–∏ –∏–∑ sessionStorage (–æ–Ω–∏ —É–∂–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã)
        const blocksJson = sessionStorage.getItem('articleBlocks');
        if (!blocksJson) {
            alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –±–ª–æ–∫–∞—Ö —Å—Ç–∞—Ç—å–∏');
            return;
        }

        const blocks = JSON.parse(blocksJson);

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        const saveBtn = document.querySelector('.btn-primary');
        const originalText = saveBtn.textContent;
        saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
        saveBtn.disabled = true;

        const formData = new FormData();
        formData.append('title', title);
        formData.append('shortDescription', shortDescription);
        formData.append('isPublished', isPublished);
        formData.append('blocks', JSON.stringify(blocks));

        try {
            const response = await fetch('/api/articles', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                const article = await response.json();
                alert('–°—Ç–∞—Ç—å—è —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!');
                sessionStorage.removeItem('articleBlocks');
                window.location.href = '/articles/' + article.id;
            } else {
                const error = await response.text();
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—å–∏: ' + error);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—å–∏: ' + error.message);
        } finally {
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            saveBtn.textContent = originalText;
            saveBtn.disabled = false;
        }
    }

    function goBack() {
        window.location.href = '/articles/editor';
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
    window.addEventListener('resize', function() {
        const textPreviews = document.querySelectorAll('.text-preview');
        textPreviews.forEach(preview => {
            adjustPreviewHeight(preview);
        });
    });
</script>
</body>
</html>