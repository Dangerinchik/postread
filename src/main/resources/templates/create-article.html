<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç–∞—Ç—å–∏</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #2c3e50;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        input[type="text"],
        textarea,
        select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        input[type="text"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .preview-section {
            margin-top: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #e9ecef;
        }

        .preview-section h3 {
            margin-bottom: 15px;
            color: #495057;
        }

        .preview-content {
            max-height: 500px;
            overflow-y: auto;
            padding: 20px;
            background-color: white;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .preview-block {
            margin-bottom: 20px;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            height: auto;
        }

        .text-preview {
            padding: 20px;
            line-height: 1.6;
            height: auto;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            width: 100%;
        }

        .text-preview p {
            margin-bottom: 1em;
            word-wrap: break-word;
        }

        .text-preview b,
        .text-preview strong {
            font-weight: bold;
        }

        .text-preview i,
        .text-preview em {
            font-style: italic;
        }

        .text-preview u {
            text-decoration: underline;
        }

        .text-preview center {
            text-align: center;
            display: block;
        }

        .text-preview right {
            text-align: right;
            display: block;
        }

        .text-preview justify {
            text-align: justify;
            display: block;
        }

        .media-preview {
            text-align: center;
            padding: 20px;
            background-color: #e9ecef;
            border-radius: 4px;
            height: auto;
        }

        .media-preview img,
        .media-preview video {
            max-width: 100%;
            max-height: 300px;
            border-radius: 4px;
        }

        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
            transition: background-color 0.2s;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #545b62;
        }

        .char-count {
            text-align: right;
            font-size: 14px;
            color: #6c757d;
            margin-top: 5px;
        }

        .blocks-info {
            background-color: #e7f3ff;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
            border-left: 4px solid #3498db;
        }

        .blocks-info h4 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .file-info {
            background-color: #d1ecf1;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            border-left: 4px solid #17a2b8;
        }

        .file-info h5 {
            margin-bottom: 5px;
            color: #0c5460;
        }

        .user-info {
            background-color: #e8f5e8;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
            border-left: 4px solid #28a745;
        }

        .user-info h4 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .formatted-preview {
            line-height: 1.6;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            width: 100%;
            height: auto;
        }

        .formatted-preview p {
            margin-bottom: 1em;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .formatted-preview b,
        .formatted-preview strong {
            font-weight: bold;
        }

        .formatted-preview i,
        .formatted-preview em {
            font-style: italic;
        }

        .formatted-preview u {
            text-decoration: underline;
        }

        .formatted-preview center {
            text-align: center;
            display: block;
        }

        .formatted-preview right {
            text-align: right;
            display: block;
        }

        .formatted-preview justify {
            text-align: justify;
            display: block;
        }

        .formatted-preview {
            overflow-wrap: break-word;
            word-break: break-word;
        }

        .formatted-preview * {
            max-width: 100%;
            word-wrap: break-word;
        }

        .empty-preview {
            color: #6c757d;
            font-style: italic;
            text-align: center;
            padding: 20px;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        /* –î–æ–±–∞–≤–ª—è–µ–º –≤ create-article.css */
        .tag-suggestions {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 150px;
            overflow-y: auto;
            z-index: 1000;
            width: 100%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .tag-suggestion {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }

        .tag-suggestion:hover {
            background-color: #f8f9fa;
        }

        .tag-suggestion:last-child {
            border-bottom: none;
        }

        .tags-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .tag-preview {
            background: #3498db;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            display: inline-block;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–µ–≥–æ–≤ –≤ —Å—Ç–∞—Ç—å—è—Ö */
        .article-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 10px 0;
        }

        .article-tag {
            background: #e9ecef;
            color: #495057;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            text-decoration: none;
            transition: background-color 0.2s;
        }

        .article-tag:hover {
            background: #3498db;
            color: white;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>–°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç–∞—Ç—å–∏</h1>

    <form id="articleForm">
        <div class="user-info">
            <h4>üë§ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–≤—Ç–æ—Ä–µ</h4>
            <div id="userInfo">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ...</div>
        </div>

        <div class="form-group">
            <label for="title">–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç–∞—Ç—å–∏ *</label>
            <input type="text" id="title" name="title"
                   placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç–∞—Ç—å–∏" required maxlength="255">
            <div class="char-count"><span id="titleCount">0</span>/255</div>
        </div>

        <div class="form-group">
            <label for="shortDescription">–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ *</label>
            <textarea id="shortDescription" name="shortDescription"
                      placeholder="–í–≤–µ–¥–∏—Ç–µ –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å—Ç–∞—Ç—å–∏ (–º–∞–∫—Å–∏–º—É–º 500 —Å–∏–º–≤–æ–ª–æ–≤)"
                      required maxlength="500"></textarea>
            <div class="char-count"><span id="descCount">0</span>/500</div>
        </div>

        <!-- –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ –ø–æ–ª—è –∫—Ä–∞—Ç–∫–æ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è -->
        <div class="form-group">
            <label for="tags">–¢–µ–≥–∏ (–º–∞–∫—Å–∏–º—É–º 3)</label>
            <input type="text" id="tags" name="tags"
                   placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–≥–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ #—Ç–µ–≥"
                   maxlength="100">
            <div class="char-count"><span id="tagsCount">0</span>/100</div>
            <small style="color: #6c757d;">
                –ü—Ä–∏–º–µ—Ä: #–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ, #java, #spring. –ú–∞–∫—Å–∏–º—É–º 3 —Ç–µ–≥–∞.
            </small>
            <div id="tagSuggestions" class="tag-suggestions"></div>
        </div>

        <!-- –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–µ–∫—Ü–∏—é –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ -->
        <div class="tags-preview" id="tagsPreview">
            <!-- –¢–µ–≥–∏ –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å -->
        </div>

        <div class="form-group">
            <div class="checkbox-group">
                <input type="checkbox" id="isPublished" name="isPublished">
                <label for="isPublished">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Å—Ç–∞—Ç—å—é —Å—Ä–∞–∑—É</label>
            </div>
        </div>

        <div class="blocks-info">
            <h4>üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–ª–æ–∫–∞—Ö</h4>
            <div id="blocksSummary">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –±–ª–æ–∫–∞—Ö...</div>
        </div>

        <div class="file-info">
            <h5>üìé –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–∞–π–ª–∞—Ö</h5>
            <div id="filesInfo">–§–∞–π–ª—ã —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏ –≥–æ—Ç–æ–≤—ã –∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—é</div>
        </div>

        <div class="preview-section">
            <h3>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–∞—Ç—å–∏</h3>
            <div id="contentPreview" class="preview-content">
                <!-- –ë–ª–æ–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
            </div>
        </div>

        <div class="button-group">
            <button type="button" class="btn btn-secondary" onclick="goBack()">‚Üê –ù–∞–∑–∞–¥ –∫ —Ä–µ–¥–∞–∫—Ç–æ—Ä—É</button>
            <button type="button" class="btn btn-primary" onclick="saveArticle()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–∞—Ç—å—é</button>
        </div>
    </form>
</div>

<script>
    let currentUserId = null;
    let currentUsername = null;

    document.addEventListener('DOMContentLoaded', function() {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –∏ –ø–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        checkAuthentication();

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –±–ª–æ–∫–∏ –∏–∑ sessionStorage
        const blocksJson = sessionStorage.getItem('articleBlocks');
        if (blocksJson) {
            const blocks = JSON.parse(blocksJson);
            displayPreview(blocks);
            updateBlocksSummary(blocks);
            updateFilesInfo(blocks);
        } else {
            alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –±–ª–æ–∫–∞—Ö —Å—Ç–∞—Ç—å–∏. –í–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä.');
            goBack();
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–æ–ª–µ–π —Ñ–æ—Ä–º—ã
        document.getElementById('title').addEventListener('input', function() {
            document.getElementById('titleCount').textContent = this.value.length;
        });

        document.getElementById('shortDescription').addEventListener('input', function() {
            document.getElementById('descCount').textContent = this.value.length;
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤
        document.getElementById('titleCount').textContent = document.getElementById('title').value.length;
        document.getElementById('descCount').textContent = document.getElementById('shortDescription').value.length;
    });

    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
    async function checkAuthentication() {
        try {
            const response = await fetch('/secured/user');
            if (response.ok) {
                const username = await response.text();
                currentUsername = username;

                // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
                await getUserInfo();
            } else {
                window.location.href = '/auth/login';
            }
        } catch (error) {
            console.error('Auth check failed:', error);
            window.location.href = '/auth/login';
        }
    }

    // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
    async function getUserInfo() {
        try {
            const response = await fetch('/articles/api/user/current');
            if (response.ok) {
                const userData = await response.json();
                currentUserId = userData.id;
                currentUsername = userData.username;
                updateUserInfo();
            } else {
                throw new Error('Failed to get user info');
            }
        } catch (error) {
            console.error('Failed to get user info:', error);
            updateUserInfoFromSession();
        }
    }

    function updateUserInfo() {
        const userInfo = document.getElementById('userInfo');
        if (currentUserId && currentUsername) {
            userInfo.innerHTML = `
                –ê–≤—Ç–æ—Ä: <strong>${currentUsername}</strong><br>
                ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: <strong>${currentUserId}</strong>
            `;
        } else {
            userInfo.innerHTML = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ';
        }
    }

    function updateUserInfoFromSession() {
        const userInfo = document.getElementById('userInfo');
        userInfo.innerHTML = `
            –ê–≤—Ç–æ—Ä: <strong>${currentUsername || '–¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</strong><br>
            <small>ID –±—É–¥–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏</small>
        `;
    }

    function displayPreview(blocks) {
        const preview = document.getElementById('contentPreview');
        preview.innerHTML = '';

        if (blocks.length === 0) {
            preview.innerHTML = '<div class="empty-preview">–ù–µ—Ç –±–ª–æ–∫–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>';
            return;
        }

        blocks.forEach((block, index) => {
            const blockDiv = document.createElement('div');
            blockDiv.className = 'preview-block';

            let content = '';
            if (block.type === 'text') {
                content = `
                    <div class="text-preview formatted-preview">${block.content}</div>
                `;
            } else if (block.type === 'media') {
                const isUploadedFile = block.content &&
                    (block.content.match(/\.(jpg|jpeg|png|gif|webp|mp4|webm|ogg|mov|mp3|wav)$/i) ||
                        block.content.length === 36 + 4);

                if (isUploadedFile) {
                    content = `
                        <div class="media-preview">
                            <strong>–§–∞–π–ª:</strong> ${block.content}
                            <br><small style="color: #28a745;">‚úì –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä</small>
                        </div>
                    `;
                } else {
                    content = `
                        <div class="media-preview">
                            <strong>–§–∞–π–ª:</strong> ${block.content}
                        </div>
                    `;
                }
            }

            blockDiv.innerHTML = content;
            preview.appendChild(blockDiv);
        });

        setTimeout(() => {
            const textPreviews = preview.querySelectorAll('.text-preview');
            textPreviews.forEach(preview => {
                adjustPreviewHeight(preview);
            });
        }, 100);
    }

    function adjustPreviewHeight(element) {
        element.style.height = 'auto';
        const newHeight = element.scrollHeight;
        element.style.height = newHeight + 'px';
        handleLongWordsInPreview(element);
    }

    function handleLongWordsInPreview(element) {
        const text = element.innerText || element.textContent;
        const words = text.split(/\s+/);
        const veryLongWords = words.filter(word => word.length > 30);

        if (veryLongWords.length > 0) {
            console.log('–í –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã –æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω—ã–µ —Å–ª–æ–≤–∞:', veryLongWords);
        }
    }

    function updateBlocksSummary(blocks) {
        const summary = document.getElementById('blocksSummary');
        const textBlocks = blocks.filter(block => block.type === 'text').length;
        const mediaBlocks = blocks.filter(block => block.type === 'media').length;

        summary.innerHTML = `
            –í—Å–µ–≥–æ –±–ª–æ–∫–æ–≤: <strong>${blocks.length}</strong><br>
            –¢–µ–∫—Å—Ç–æ–≤—ã—Ö –±–ª–æ–∫–æ–≤: <strong>${textBlocks}</strong><br>
            –ú–µ–¥–∏–∞ –±–ª–æ–∫–æ–≤: <strong>${mediaBlocks}</strong>
        `;
    }

    function updateFilesInfo(blocks) {
        const filesInfo = document.getElementById('filesInfo');
        const mediaBlocks = blocks.filter(block => block.type === 'media');
        const uploadedFiles = mediaBlocks.filter(block =>
            block.content &&
            (block.content.match(/\.(jpg|jpeg|png|gif|webp|mp4|webm|ogg|mov|mp3|wav)$/i) ||
                block.content.length === 36 + 4)
        );

        if (mediaBlocks.length === 0) {
            filesInfo.innerHTML = '–ú–µ–¥–∏–∞-—Ñ–∞–π–ª—ã –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã';
        } else if (uploadedFiles.length === mediaBlocks.length) {
            filesInfo.innerHTML = `
                –í—Å–µ —Ñ–∞–π–ª—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã: <strong>${uploadedFiles.length}</strong> –∏–∑ <strong>${mediaBlocks.length}</strong>
                <br><small style="color: #28a745;">‚úì –í—Å–µ —Ñ–∞–π–ª—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä</small>
            `;
        } else {
            filesInfo.innerHTML = `
                –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: <strong>${uploadedFiles.length}</strong> –∏–∑ <strong>${mediaBlocks.length}</strong>
                <br><small style="color: #dc3545;">‚ö† –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ñ–∞–π–ª—ã –º–æ–≥—É—Ç –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ</small>
            `;
        }
    }

    async function saveArticle() {
        const title = document.getElementById('title').value;
        const shortDescription = document.getElementById('shortDescription').value;
        const isPublished = document.getElementById('isPublished').checked;

        // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã
        if (!title.trim()) {
            alert('–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç–∞—Ç—å–∏');
            return;
        }

        if (!shortDescription.trim()) {
            alert('–í–≤–µ–¥–∏—Ç–µ –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å—Ç–∞—Ç—å–∏');
            return;
        }

        // –ü–æ–ª—É—á–∞–µ–º –±–ª–æ–∫–∏ –∏–∑ sessionStorage
        const blocksJson = sessionStorage.getItem('articleBlocks');
        if (!blocksJson) {
            alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –±–ª–æ–∫–∞—Ö —Å—Ç–∞—Ç—å–∏');
            return;
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        const saveBtn = document.querySelector('.btn-primary');
        const originalText = saveBtn.textContent;
        saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
        saveBtn.disabled = true;
        document.body.classList.add('loading');

        try {
            const formData = new FormData();
            formData.append('title', title);
            formData.append('shortDescription', shortDescription);
            formData.append('blocks', blocksJson);
            // –£–±–∏—Ä–∞–µ–º authorId - —Å–µ—Ä–≤–µ—Ä —Å–∞–º –æ–ø—Ä–µ–¥–µ–ª–∏—Ç —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            formData.append('isPublished', isPublished.toString());

            const response = await fetch('/articles/create', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                const article = await response.json();
                alert('–°—Ç–∞—Ç—å—è —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!');
                sessionStorage.removeItem('articleBlocks');
                window.location.href = '/articles/' + article.id;
            } else {
                const errorText = await response.text();
                let errorMessage = '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—å–∏';
                try {
                    const errorData = JSON.parse(errorText);
                    errorMessage = errorData.message || errorMessage;
                } catch (e) {
                    errorMessage = errorText;
                }
                alert(errorMessage);

                if (response.status === 401) {
                    window.location.href = '/auth/login';
                }
            }
        } catch (error) {
            console.error('Error:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—å–∏: ' + error.message);
        } finally {
            saveBtn.textContent = originalText;
            saveBtn.disabled = false;
            document.body.classList.remove('loading');
        }
    }

    function goBack() {
        window.location.href = '/articles/editor';
    }

    window.addEventListener('resize', function() {
        const textPreviews = document.querySelectorAll('.text-preview');
        textPreviews.forEach(preview => {
            adjustPreviewHeight(preview);
        });
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–æ–ª—è —Ç–µ–≥–æ–≤
    document.getElementById('tags').addEventListener('input', function(e) {
        const tagsText = e.target.value;
        document.getElementById('tagsCount').textContent = tagsText.length;

        // –ê–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–µ–≥–æ–≤
        if (tagsText.length > 1) {
            searchTagSuggestions(tagsText);
        } else {
            clearTagSuggestions();
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ç–µ–≥–æ–≤
        updateTagsPreview(tagsText);
    });

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π —Ç–µ–≥–æ–≤
    async function searchTagSuggestions(query) {
        try {
            const response = await fetch(`/articles/api/tags?query=${encodeURIComponent(query)}`);
            if (response.ok) {
                const tags = await response.json();
                displayTagSuggestions(tags);
            }
        } catch (error) {
            console.error('Error fetching tag suggestions:', error);
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π —Ç–µ–≥–æ–≤
    function displayTagSuggestions(tags) {
        const suggestionsContainer = document.getElementById('tagSuggestions');
        suggestionsContainer.innerHTML = '';

        if (tags.length === 0) {
            suggestionsContainer.style.display = 'none';
            return;
        }

        suggestionsContainer.style.display = 'block';

        tags.forEach(tag => {
            const suggestion = document.createElement('div');
            suggestion.className = 'tag-suggestion';
            suggestion.textContent = `#${tag.name}`;
            suggestion.onclick = () => {
                addTagToInput(tag.name);
            };
            suggestionsContainer.appendChild(suggestion);
        });
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–µ–≥–∞ –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
    function addTagToInput(tagName) {
        const tagsInput = document.getElementById('tags');
        const currentTags = tagsInput.value.split(',').map(tag => tag.trim()).filter(tag => tag);

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø—Ä–µ–≤—ã—à–µ–Ω –ª–∏ –ª–∏–º–∏—Ç —Ç–µ–≥–æ–≤
        if (currentTags.length >= 3) {
            alert('–ú–∞–∫—Å–∏–º—É–º 3 —Ç–µ–≥–∞ –Ω–∞ —Å—Ç–∞—Ç—å—é');
            return;
        }

        // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–≥, –µ—Å–ª–∏ –µ–≥–æ –µ—â–µ –Ω–µ—Ç
        if (!currentTags.includes(tagName)) {
            currentTags.push(tagName);
            tagsInput.value = currentTags.join(', ');
            updateTagsPreview(tagsInput.value);
        }

        clearTagSuggestions();
        tagsInput.focus();
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ç–µ–≥–æ–≤
    function updateTagsPreview(tagsText) {
        const previewContainer = document.getElementById('tagsPreview');
        const tags = extractTagsFromText(tagsText);

        previewContainer.innerHTML = '';

        if (tags.length === 0) {
            previewContainer.innerHTML = '<div class="empty-preview">–¢–µ–≥–∏ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</div>';
            return;
        }

        tags.forEach(tag => {
            const tagElement = document.createElement('span');
            tagElement.className = 'tag-preview';
            tagElement.textContent = `#${tag}`;
            previewContainer.appendChild(tagElement);
        });
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ç–µ–≥–æ–≤ –∏–∑ —Ç–µ–∫—Å—Ç–∞
    function extractTagsFromText(text) {
        if (!text) return [];

        const tagPattern = /#(\w+)/g;
        const matches = text.match(tagPattern);

        if (!matches) return [];

        return matches.map(match => match.substring(1)) // –£–±–∏—Ä–∞–µ–º #
            .slice(0, 3); // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º 3 —Ç–µ–≥–∞–º–∏
    }

    function clearTagSuggestions() {
        const suggestionsContainer = document.getElementById('tagSuggestions');
        suggestionsContainer.innerHTML = '';
        suggestionsContainer.style.display = 'none';
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é saveArticle –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ–≥–æ–≤
    async function saveArticle() {
        const title = document.getElementById('title').value;
        const shortDescription = document.getElementById('shortDescription').value;
        const isPublished = document.getElementById('isPublished').checked;
        const tagsText = document.getElementById('tags').value;

        // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–≥–∏ –∏–∑ —Ç–µ–∫—Å—Ç–∞
        const tags = extractTagsFromText(tagsText);

        // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã
        if (!title.trim()) {
            alert('–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç–∞—Ç—å–∏');
            return;
        }

        if (!shortDescription.trim()) {
            alert('–í–≤–µ–¥–∏—Ç–µ –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å—Ç–∞—Ç—å–∏');
            return;
        }

        // –ü–æ–ª—É—á–∞–µ–º –±–ª–æ–∫–∏ –∏–∑ sessionStorage
        const blocksJson = sessionStorage.getItem('articleBlocks');
        if (!blocksJson) {
            alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –±–ª–æ–∫–∞—Ö —Å—Ç–∞—Ç—å–∏');
            return;
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        const saveBtn = document.querySelector('.btn-primary');
        const originalText = saveBtn.textContent;
        saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
        saveBtn.disabled = true;
        document.body.classList.add('loading');

        try {
            const formData = new FormData();
            formData.append('title', title);
            formData.append('shortDescription', shortDescription);
            formData.append('blocks', blocksJson);
            formData.append('isPublished', isPublished.toString());

            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–≥–∏
            tags.forEach(tag => {
                formData.append('tags', tag);
            });

            const response = await fetch('/articles/create', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                const article = await response.json();
                alert('–°—Ç–∞—Ç—å—è —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!');
                sessionStorage.removeItem('articleBlocks');
                window.location.href = '/articles/' + article.id;
            } else {
                const errorText = await response.text();
                let errorMessage = '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—å–∏';
                try {
                    const errorData = JSON.parse(errorText);
                    errorMessage = errorData.message || errorMessage;
                } catch (e) {
                    errorMessage = errorText;
                }
                alert(errorMessage);

                if (response.status === 401) {
                    window.location.href = '/auth/login';
                }
            }
        } catch (error) {
            console.error('Error:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—å–∏: ' + error.message);
        } finally {
            saveBtn.textContent = originalText;
            saveBtn.disabled = false;
            document.body.classList.remove('loading');
        }
    }
</script>
</body>
</html>