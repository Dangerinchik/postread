<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç–∞—Ç—å–∏</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #2c3e50;
        }

        .form-group {
            margin-bottom: 20px;
            position: relative;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        input[type="text"],
        textarea,
        select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        input[type="text"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .preview-section {
            margin-top: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #e9ecef;
        }

        .preview-section h3 {
            margin-bottom: 15px;
            color: #495057;
        }

        .preview-content {
            max-height: 500px;
            overflow-y: auto;
            padding: 20px;
            background-color: white;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .preview-block {
            margin-bottom: 20px;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            height: auto;
        }

        .text-preview {
            padding: 20px;
            line-height: 1.6;
            height: auto;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            width: 100%;
        }

        .text-preview p {
            margin-bottom: 1em;
            word-wrap: break-word;
        }

        .text-preview b,
        .text-preview strong {
            font-weight: bold;
        }

        .text-preview i,
        .text-preview em {
            font-style: italic;
        }

        .text-preview u {
            text-decoration: underline;
        }

        .text-preview center {
            text-align: center;
            display: block;
        }

        .text-preview right {
            text-align: right;
            display: block;
        }

        .text-preview justify {
            text-align: justify;
            display: block;
        }

        .media-preview {
            text-align: center;
            padding: 20px;
            background-color: #e9ecef;
            border-radius: 4px;
            height: auto;
        }

        .media-preview img,
        .media-preview video {
            max-width: 100%;
            max-height: 300px;
            border-radius: 4px;
        }

        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
            transition: background-color 0.2s;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #545b62;
        }

        .char-count {
            text-align: right;
            font-size: 14px;
            color: #6c757d;
            margin-top: 5px;
        }

        .blocks-info {
            background-color: #e7f3ff;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
            border-left: 4px solid #3498db;
        }

        .blocks-info h4 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .file-info {
            background-color: #d1ecf1;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            border-left: 4px solid #17a2b8;
        }

        .file-info h5 {
            margin-bottom: 5px;
            color: #0c5460;
        }

        .user-info {
            background-color: #e8f5e8;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
            border-left: 4px solid #28a745;
        }

        .user-info h4 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .formatted-preview {
            line-height: 1.6;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            width: 100%;
            height: auto;
        }

        .formatted-preview p {
            margin-bottom: 1em;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .formatted-preview b,
        .formatted-preview strong {
            font-weight: bold;
        }

        .formatted-preview i,
        .formatted-preview em {
            font-style: italic;
        }

        .formatted-preview u {
            text-decoration: underline;
        }

        .formatted-preview center {
            text-align: center;
            display: block;
        }

        .formatted-preview right {
            text-align: right;
            display: block;
        }

        .formatted-preview justify {
            text-align: justify;
            display: block;
        }

        .formatted-preview {
            overflow-wrap: break-word;
            word-break: break-word;
        }

        .formatted-preview * {
            max-width: 100%;
            word-wrap: break-word;
        }

        .empty-preview {
            color: #6c757d;
            font-style: italic;
            text-align: center;
            padding: 20px;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .tag-suggestions {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 150px;
            overflow-y: auto;
            z-index: 1000;
            width: 100%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: none;
        }

        .tag-suggestion {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }

        .tag-suggestion:hover {
            background-color: #f8f9fa;
        }

        .tag-suggestion:last-child {
            border-bottom: none;
        }

        .tags-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .tag-preview {
            background: #3498db;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            display: inline-block;
        }

        .article-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 10px 0;
        }

        .article-tag {
            background: #e9ecef;
            color: #495057;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            text-decoration: none;
            transition: background-color 0.2s;
        }

        .article-tag:hover {
            background: #3498db;
            color: white;
        }

        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>–°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç–∞—Ç—å–∏</h1>

    <form id="articleForm">
        <div class="user-info">
            <h4>üë§ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–≤—Ç–æ—Ä–µ</h4>
            <div id="userInfo">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ...</div>
        </div>

        <div class="form-group">
            <label for="title">–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç–∞—Ç—å–∏ *</label>
            <input type="text" id="title" name="title"
                   placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç–∞—Ç—å–∏" required maxlength="255">
            <div class="char-count"><span id="titleCount">0</span>/255</div>
        </div>

        <div class="form-group">
            <label for="shortDescription">–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ *</label>
            <textarea id="shortDescription" name="shortDescription"
                      placeholder="–í–≤–µ–¥–∏—Ç–µ –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å—Ç–∞—Ç—å–∏ (–º–∞–∫—Å–∏–º—É–º 500 —Å–∏–º–≤–æ–ª–æ–≤)"
                      required maxlength="500"></textarea>
            <div class="char-count"><span id="descCount">0</span>/500</div>
        </div>

        <div class="form-group">
            <label for="tags">–¢–µ–≥–∏ (–º–∞–∫—Å–∏–º—É–º 3)</label>
            <input type="text" id="tags" name="tags"
                   placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–≥–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ #—Ç–µ–≥"
                   maxlength="100">
            <div class="char-count"><span id="tagsCount">0</span>/100</div>
            <small style="color: #6c757d;">
                –ü—Ä–∏–º–µ—Ä: #–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ, #java, #spring. –ú–∞–∫—Å–∏–º—É–º 3 —Ç–µ–≥–∞.
            </small>
            <div id="tagSuggestions" class="tag-suggestions"></div>
        </div>

        <div class="tags-preview" id="tagsPreview">
            <!-- –¢–µ–≥–∏ –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å -->
        </div>

        <div class="form-group">
            <div class="checkbox-group">
                <input type="checkbox" id="isPublished" name="isPublished">
                <label for="isPublished">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Å—Ç–∞—Ç—å—é —Å—Ä–∞–∑—É</label>
            </div>
        </div>

        <div class="blocks-info">
            <h4>üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–ª–æ–∫–∞—Ö</h4>
            <div id="blocksSummary">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –±–ª–æ–∫–∞—Ö...</div>
        </div>

        <div class="file-info">
            <h5>üìé –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–∞–π–ª–∞—Ö</h5>
            <div id="filesInfo">–§–∞–π–ª—ã —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏ –≥–æ—Ç–æ–≤—ã –∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—é</div>
        </div>

        <div class="preview-section">
            <h3>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–∞—Ç—å–∏</h3>
            <div id="contentPreview" class="preview-content">
                <!-- –ë–ª–æ–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
            </div>
        </div>

        <div class="button-group">
            <button type="button" class="btn btn-secondary" onclick="goBack()">‚Üê –ù–∞–∑–∞–¥ –∫ —Ä–µ–¥–∞–∫—Ç–æ—Ä—É</button>
            <button type="button" class="btn btn-primary" onclick="saveArticle()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–∞—Ç—å—é</button>
        </div>
    </form>
</div>

<script>
    let currentUserId = null;
    let currentUsername = null;
    let isEditMode = false;
    let currentArticleId = null;

    document.addEventListener('DOMContentLoaded', function() {
        checkAuthentication();
        initializeFormHandlers();
        loadBlocksSilently();
        checkEditMode();
    });

    function initializeFormHandlers() {
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–æ–ª–µ–π —Ñ–æ—Ä–º—ã
        document.getElementById('title').addEventListener('input', function() {
            document.getElementById('titleCount').textContent = this.value.length;
        });

        document.getElementById('shortDescription').addEventListener('input', function() {
            document.getElementById('descCount').textContent = this.value.length;
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ç–µ–≥–æ–≤
        document.getElementById('tags').addEventListener('input', function(e) {
            const tagsText = e.target.value;
            document.getElementById('tagsCount').textContent = tagsText.length;

            if (tagsText.length > 1) {
                searchTagSuggestions(tagsText);
            } else {
                clearTagSuggestions();
            }

            updateTagsPreview(tagsText);
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–¥—Å–∫–∞–∑–æ–∫ —Ç–µ–≥–æ–≤ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –ø–æ–ª—è
        document.addEventListener('click', function(e) {
            if (!e.target.closest('#tags') && !e.target.closest('#tagSuggestions')) {
                clearTagSuggestions();
            }
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤
        document.getElementById('titleCount').textContent = document.getElementById('title').value.length;
        document.getElementById('descCount').textContent = document.getElementById('shortDescription').value.length;
    }

    function checkEditMode() {
        const urlParams = new URLSearchParams(window.location.search);
        isEditMode = urlParams.get('edit') === 'true';
        currentArticleId = urlParams.get('articleId');

        if (isEditMode) {
            document.querySelector('h1').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—å–∏';
            const saveBtn = document.querySelector('.btn-primary');
            if (saveBtn) {
                saveBtn.textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
            }

            const editData = sessionStorage.getItem('editArticleData');
            if (editData) {
                try {
                    const articleData = JSON.parse(editData);
                    prefillForm(articleData);
                } catch (e) {
                    console.error('Error parsing edit data:', e);
                    redirectToArticlesList('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
                }
            } else if (currentArticleId) {
                loadArticleData(currentArticleId);
            } else {
                redirectToArticlesList('–ù–µ —É–∫–∞–∑–∞–Ω ID —Å—Ç–∞—Ç—å–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
            }
        }
    }

    async function checkAuthentication() {
        try {
            const response = await fetch('/secured/user');
            if (response.ok) {
                const username = await response.text();
                currentUsername = username;
                await getUserInfo();
            } else {
                window.location.href = '/auth/login';
            }
        } catch (error) {
            console.error('Auth check failed:', error);
            window.location.href = '/auth/login';
        }
    }

    async function getUserInfo() {
        try {
            const response = await fetch('/articles/api/user/current');
            if (response.ok) {
                const userData = await response.json();
                currentUserId = userData.id;
                currentUsername = userData.username;
                updateUserInfo();
            } else {
                throw new Error('Failed to get user info');
            }
        } catch (error) {
            console.error('Failed to get user info:', error);
            updateUserInfoFromSession();
        }
    }

    function updateUserInfo() {
        const userInfo = document.getElementById('userInfo');
        if (currentUserId && currentUsername) {
            userInfo.innerHTML = `
                –ê–≤—Ç–æ—Ä: <strong>${currentUsername}</strong><br>
                ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: <strong>${currentUserId}</strong>
            `;
        } else {
            userInfo.innerHTML = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ';
        }
    }

    function updateUserInfoFromSession() {
        const userInfo = document.getElementById('userInfo');
        userInfo.innerHTML = `
            –ê–≤—Ç–æ—Ä: <strong>${currentUsername || '–¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</strong><br>
            <small>ID –±—É–¥–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏</small>
        `;
    }

    function loadBlocksSilently() {
        const blocksJson = sessionStorage.getItem('articleBlocks');
        if (blocksJson) {
            try {
                const blocks = JSON.parse(blocksJson);
                displayPreview(blocks);
                updateBlocksSummary(blocks);
                updateFilesInfo(blocks);
            } catch (e) {
                console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –±–ª–æ–∫–∏:', e);
                displayPreview([]);
                updateBlocksSummary([]);
                updateFilesInfo([]);
            }
        } else {
            console.log('–ë–ª–æ–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ sessionStorage');
            displayPreview([]);
            updateBlocksSummary([]);
            updateFilesInfo([]);
        }
    }

    function displayPreview(blocks) {
        const preview = document.getElementById('contentPreview');
        preview.innerHTML = '';

        if (blocks.length === 0) {
            preview.innerHTML = '<div class="empty-preview">–ù–µ—Ç –±–ª–æ–∫–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>';
            return;
        }

        blocks.forEach((block, index) => {
            const blockDiv = document.createElement('div');
            blockDiv.className = 'preview-block';

            let content = '';
            if (block.type === 'text') {
                content = `
                    <div class="text-preview formatted-preview">${block.content}</div>
                `;
            } else if (block.type === 'media') {
                const isUploadedFile = block.content &&
                    (block.content.match(/\.(jpg|jpeg|png|gif|webp|mp4|webm|ogg|mov|mp3|wav)$/i) ||
                        block.content.length === 36 + 4);

                if (isUploadedFile) {
                    content = `
                        <div class="media-preview">
                            <strong>–§–∞–π–ª:</strong> ${block.content}
                            <br><small style="color: #28a745;">‚úì –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä</small>
                        </div>
                    `;
                } else {
                    content = `
                        <div class="media-preview">
                            <strong>–§–∞–π–ª:</strong> ${block.content}
                        </div>
                    `;
                }
            }

            blockDiv.innerHTML = content;
            preview.appendChild(blockDiv);
        });

        setTimeout(() => {
            const textPreviews = preview.querySelectorAll('.text-preview');
            textPreviews.forEach(preview => {
                adjustPreviewHeight(preview);
            });
        }, 100);
    }

    function adjustPreviewHeight(element) {
        element.style.height = 'auto';
        const newHeight = element.scrollHeight;
        element.style.height = newHeight + 'px';
        handleLongWordsInPreview(element);
    }

    function handleLongWordsInPreview(element) {
        const text = element.innerText || element.textContent;
        const words = text.split(/\s+/);
        const veryLongWords = words.filter(word => word.length > 30);

        if (veryLongWords.length > 0) {
            console.log('–í –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã –æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω—ã–µ —Å–ª–æ–≤–∞:', veryLongWords);
        }
    }

    function updateBlocksSummary(blocks) {
        const summary = document.getElementById('blocksSummary');
        const textBlocks = blocks.filter(block => block.type === 'text').length;
        const mediaBlocks = blocks.filter(block => block.type === 'media').length;

        summary.innerHTML = `
            –í—Å–µ–≥–æ –±–ª–æ–∫–æ–≤: <strong>${blocks.length}</strong><br>
            –¢–µ–∫—Å—Ç–æ–≤—ã—Ö –±–ª–æ–∫–æ–≤: <strong>${textBlocks}</strong><br>
            –ú–µ–¥–∏–∞ –±–ª–æ–∫–æ–≤: <strong>${mediaBlocks}</strong>
        `;
    }

    function updateFilesInfo(blocks) {
        const filesInfo = document.getElementById('filesInfo');
        const mediaBlocks = blocks.filter(block => block.type === 'media');
        const uploadedFiles = mediaBlocks.filter(block =>
            block.content &&
            (block.content.match(/\.(jpg|jpeg|png|gif|webp|mp4|webm|ogg|mov|mp3|wav)$/i) ||
                block.content.length === 36 + 4)
        );

        if (mediaBlocks.length === 0) {
            filesInfo.innerHTML = '–ú–µ–¥–∏–∞-—Ñ–∞–π–ª—ã –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã';
        } else if (uploadedFiles.length === mediaBlocks.length) {
            filesInfo.innerHTML = `
                –í—Å–µ —Ñ–∞–π–ª—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã: <strong>${uploadedFiles.length}</strong> –∏–∑ <strong>${mediaBlocks.length}</strong>
                <br><small style="color: #28a745;">‚úì –í—Å–µ —Ñ–∞–π–ª—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä</small>
            `;
        } else {
            filesInfo.innerHTML = `
                –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: <strong>${uploadedFiles.length}</strong> –∏–∑ <strong>${mediaBlocks.length}</strong>
                <br><small style="color: #dc3545;">‚ö† –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ñ–∞–π–ª—ã –º–æ–≥—É—Ç –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ</small>
            `;
        }
    }

    async function searchTagSuggestions(query) {
        try {
            const response = await fetch(`/articles/api/tags?query=${encodeURIComponent(query)}`);
            if (response.ok) {
                const tags = await response.json();
                displayTagSuggestions(tags);
            }
        } catch (error) {
            console.error('Error fetching tag suggestions:', error);
        }
    }

    function displayTagSuggestions(tags) {
        const suggestionsContainer = document.getElementById('tagSuggestions');
        suggestionsContainer.innerHTML = '';

        if (tags.length === 0) {
            suggestionsContainer.style.display = 'none';
            return;
        }

        suggestionsContainer.style.display = 'block';

        tags.forEach(tag => {
            const suggestion = document.createElement('div');
            suggestion.className = 'tag-suggestion';
            suggestion.textContent = `#${tag.name}`;
            suggestion.onclick = () => {
                addTagToInput(tag.name);
            };
            suggestionsContainer.appendChild(suggestion);
        });
    }

    function addTagToInput(tagName) {
        const tagsInput = document.getElementById('tags');
        const currentTags = tagsInput.value.split(',').map(tag => tag.trim()).filter(tag => tag);

        if (currentTags.length >= 3) {
            alert('–ú–∞–∫—Å–∏–º—É–º 3 —Ç–µ–≥–∞ –Ω–∞ —Å—Ç–∞—Ç—å—é');
            return;
        }

        if (!currentTags.includes(tagName)) {
            currentTags.push(tagName);
            tagsInput.value = currentTags.join(', ');
            updateTagsPreview(tagsInput.value);
        }

        clearTagSuggestions();
        tagsInput.focus();
    }

    function updateTagsPreview(tagsText) {
        const previewContainer = document.getElementById('tagsPreview');
        const tags = extractTagsFromText(tagsText);

        previewContainer.innerHTML = '';

        if (tags.length === 0) {
            previewContainer.innerHTML = '<div class="empty-preview">–¢–µ–≥–∏ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</div>';
            return;
        }

        tags.forEach(tag => {
            const tagElement = document.createElement('span');
            tagElement.className = 'tag-preview';
            tagElement.textContent = `#${tag}`;
            previewContainer.appendChild(tagElement);
        });
    }

    function extractTagsFromText(text) {
        if (!text) return [];

        const tagPattern = /#(\w+)/g;
        const matches = text.match(tagPattern);

        if (!matches) return [];

        return matches.map(match => match.substring(1))
            .slice(0, 3);
    }

    function clearTagSuggestions() {
        const suggestionsContainer = document.getElementById('tagSuggestions');
        suggestionsContainer.innerHTML = '';
        suggestionsContainer.style.display = 'none';
    }

    function prefillForm(articleData) {
        console.log('–ü—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã –¥–∞–Ω–Ω—ã–º–∏:', articleData);

        const titleInput = document.getElementById('title');
        if (titleInput && articleData.title) {
            titleInput.value = articleData.title;
            document.getElementById('titleCount').textContent = articleData.title.length;
        }

        const descInput = document.getElementById('shortDescription');
        if (descInput && articleData.shortDescription) {
            descInput.value = articleData.shortDescription;
            document.getElementById('descCount').textContent = articleData.shortDescription.length;
        }

        const tagsInput = document.getElementById('tags');
        if (tagsInput && articleData.tags && articleData.tags.length > 0) {
            const tagsText = articleData.tags.map(tag => `#${tag}`).join(', ');
            tagsInput.value = tagsText;
            document.getElementById('tagsCount').textContent = tagsText.length;
            updateTagsPreview(tagsText);
        }

        const publishCheckbox = document.getElementById('isPublished');
        if (publishCheckbox && articleData.isPublished !== undefined) {
            publishCheckbox.checked = articleData.isPublished;
        }

        if (articleData.blocks && articleData.blocks.length > 0) {
            console.log('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –±–ª–æ–∫–æ–≤ –≤ sessionStorage:', articleData.blocks.length);
            sessionStorage.setItem('articleBlocks', JSON.stringify(articleData.blocks));
            displayPreview(articleData.blocks);
            updateBlocksSummary(articleData.blocks);
            updateFilesInfo(articleData.blocks);
        } else {
            loadBlocksSilently();
        }
    }

    async function loadArticleData(articleId) {
        try {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å ID
            if (!articleId || articleId === 'undefined' || articleId === 'null') {
                throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å—Ç–∞—Ç—å–∏');
            }

            const response = await fetch(`/articles/api/${articleId}`);

            if (response.ok) {
                const article = await response.json();
                prefillForm({
                    title: article.title,
                    shortDescription: article.shortDescription,
                    tags: article.tags ? Array.from(article.tags).map(tag => tag.name) : [],
                    isPublished: article.published,
                    blocks: article.blocks || []
                });
            } else if (response.status === 400) {
                redirectToArticlesList('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞ —Å—Ç–∞—Ç—å–∏');
            } else if (response.status === 404) {
                redirectToArticlesList('–°—Ç–∞—Ç—å—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
            } else {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
        } catch (error) {
            console.error('Error loading article data:', error);

            if (error.message.includes('Failed to convert') ||
                error.message.includes('MethodArgumentTypeMismatch') ||
                error.message.includes('–ù–µ–≤–µ—Ä–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä')) {
                redirectToArticlesList('–ù–µ–≤–µ—Ä–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å—Ç–∞—Ç—å–∏');
            } else {
                redirectToArticlesList('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å—Ç–∞—Ç—å–∏: ' + error.message);
            }
        }
    }

    // –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –°–û–•–†–ê–ù–ï–ù–ò–Ø –° –û–ë–†–ê–ë–û–¢–ö–û–ô –û–®–ò–ë–û–ö
    async function saveArticle() {
        const title = document.getElementById('title').value;
        const shortDescription = document.getElementById('shortDescription').value;
        const isPublished = document.getElementById('isPublished').checked;
        const tagsText = document.getElementById('tags').value;
        const tags = extractTagsFromText(tagsText);

        // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã
        if (!title.trim()) {
            alert('–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç–∞—Ç—å–∏');
            return;
        }

        if (!shortDescription.trim()) {
            alert('–í–≤–µ–¥–∏—Ç–µ –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å—Ç–∞—Ç—å–∏');
            return;
        }

        const blocksJson = sessionStorage.getItem('articleBlocks');
        if (!blocksJson) {
            alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –±–ª–æ–∫–∞—Ö —Å—Ç–∞—Ç—å–∏');
            return;
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        const saveBtn = document.querySelector('.btn-primary');
        const originalText = saveBtn.textContent;
        saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
        saveBtn.disabled = true;
        document.body.classList.add('loading');

        try {
            if (isEditMode && currentArticleId) {
                await updateExistingArticle(currentArticleId, title, shortDescription, blocksJson, isPublished, tags);
            } else {
                await createNewArticle(title, shortDescription, blocksJson, isPublished, tags);
            }
        } catch (error) {
            console.error('Error:', error);

            // –ü–†–ò –õ–Æ–ë–û–ô –û–®–ò–ë–ö–ï –í–´–ó–´–í–ê–ï–ú –§–£–ù–ö–¶–ò–Æ –û–ë–†–ê–ë–û–¢–ö–ò –û–®–ò–ë–û–ö
            handleSaveError(error);
        } finally {
            saveBtn.textContent = originalText;
            saveBtn.disabled = false;
            document.body.classList.remove('loading');
        }
    }

    // –§–£–ù–ö–¶–ò–Ø –û–ë–†–ê–ë–û–¢–ö–ò –û–®–ò–ë–û–ö –ü–†–ò –°–û–•–†–ê–ù–ï–ù–ò–ò
    function handleSaveError(error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—å–∏:', error);

        // –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
        let errorMessage = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—å–∏. ';

        if (error.message.includes('Failed to convert') ||
            error.message.includes('MethodArgumentTypeMismatch') ||
            error.message.includes('–ù–µ–≤–µ—Ä–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä')) {
            errorMessage += '–ù–µ–≤–µ—Ä–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å—Ç–∞—Ç—å–∏.';
        } else if (error.message.includes('401') || error.message.includes('Unauthorized')) {
            errorMessage += '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è.';
        } else if (error.message.includes('403') || error.message.includes('Forbidden')) {
            errorMessage += '–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è.';
        } else if (error.message.includes('404') || error.message.includes('Not Found')) {
            errorMessage += '–°—Ç–∞—Ç—å—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.';
        } else {
            errorMessage += error.message;
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º alert —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º –æ–± –æ—à–∏–±–∫–µ
        alert(errorMessage + '\n\n–í—ã –±—É–¥–µ—Ç–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å–æ —Å–ø–∏—Å–∫–æ–º —Å—Ç–∞—Ç–µ–π.');

        // –ü–ï–†–ï–ù–ê–ü–†–ê–í–õ–Ø–ï–ú –ù–ê articles-list (–±–µ–∑ .html)
        setTimeout(() => {
            window.location.href = '/articles';
        }, 1000);
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å—Ç–∞—Ç—å–∏
    async function updateExistingArticle(articleId, title, shortDescription, blocksJson, isPublished, tags) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å ID –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
        if (!articleId || articleId === 'undefined' || articleId === 'null') {
            throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å—Ç–∞—Ç—å–∏');
        }

        const formData = new FormData();
        formData.append('title', title);
        formData.append('shortDescription', shortDescription);
        formData.append('blocks', blocksJson);
        formData.append('isPublished', isPublished.toString());

        // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–≥–∏
        tags.forEach(tag => {
            formData.append('tags', tag);
        });

        const response = await fetch(`/articles/update/${articleId}`, {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            const result = await response.json();
            alert('–°—Ç–∞—Ç—å—è —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!');
            sessionStorage.removeItem('articleBlocks');
            sessionStorage.removeItem('editArticleData');

            // –ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å—Ç–∞—Ç—å–∏
            if (result.articleId) {
                window.location.href = '/articles/' + result.articleId;
            } else {
                window.location.href = '/articles';
            }
        } else {
            const errorText = await response.text();
            let errorMessage = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—å–∏';
            try {
                const errorData = JSON.parse(errorText);
                errorMessage = errorData.message || errorMessage;
            } catch (e) {
                errorMessage = errorText;
            }
            throw new Error(errorMessage);
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π —Å—Ç–∞—Ç—å–∏
    async function createNewArticle(title, shortDescription, blocksJson, isPublished, tags) {
        const formData = new FormData();
        formData.append('title', title);
        formData.append('shortDescription', shortDescription);
        formData.append('blocks', blocksJson);
        formData.append('isPublished', isPublished.toString());

        // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–≥–∏
        tags.forEach(tag => {
            formData.append('tags', tag);
        });

        const response = await fetch('/articles/create', {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            const article = await response.json();
            alert('–°—Ç–∞—Ç—å—è —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!');
            sessionStorage.removeItem('articleBlocks');
            window.location.href = '/articles/' + article.id;
        } else {
            const errorText = await response.text();
            let errorMessage = '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—å–∏';
            try {
                const errorData = JSON.parse(errorText);
                errorMessage = errorData.message || errorMessage;
            } catch (e) {
                errorMessage = errorText;
            }
            throw new Error(errorMessage);
        }
    }

    function goBack() {
        if (isEditMode && currentArticleId) {
            window.location.href = `/articles/edit/${currentArticleId}`;
        } else {
            window.location.href = '/articles/editor';
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–∞ —Å–ø–∏—Å–æ–∫ —Å—Ç–∞—Ç–µ–π
    function redirectToArticlesList(message) {
        if (message) {
            alert(message);
        }
        // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ /articles (–±–µ–∑ .html)
        window.location.href = '/articles';
    }

    window.addEventListener('resize', function() {
        const textPreviews = document.querySelectorAll('.text-preview');
        textPreviews.forEach(preview => {
            adjustPreviewHeight(preview);
        });
    });
</script>
</body>
</html>