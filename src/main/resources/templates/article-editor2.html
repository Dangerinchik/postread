<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${isEdit ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—å–∏' : '–°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç–∞—Ç—å–∏'}">–†–µ–¥–∞–∫—Ç–æ—Ä —Å—Ç–∞—Ç—å–∏</title>
    <style>
        /* –°—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #2c3e50;
        }

        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #e9ecef;
            align-items: center;
        }

        .toolbar button {
            padding: 8px 16px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            background: #fff;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .toolbar button:hover {
            background-color: #e9ecef;
        }

        .btn-primary {
            background-color: #3498db !important;
            color: white;
            border-color: #3498db !important;
        }

        .btn-primary:hover {
            background-color: #2980b9 !important;
        }

        .text-formatting-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f1f3f4;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .text-formatting-toolbar select,
        .text-formatting-toolbar input {
            padding: 4px 8px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 14px;
        }

        .format-btn {
            padding: 4px 8px;
            border: 1px solid #ccc;
            background: white;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
        }

        .format-btn:hover {
            background-color: #e9ecef;
        }

        .format-btn.active {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
        }

        .blocks-container {
            min-height: 500px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 20px;
            background-color: #fafafa;
        }

        .block {
            margin-bottom: 20px;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            position: relative;
            transition: border-color 0.2s;
        }

        .block:hover {
            border-color: #3498db;
        }

        .text-block {
            min-height: 60px;
        }

        .media-block {
            text-align: center;
            padding: 20px;
        }

        .rich-text-editor {
            width: 100%;
            min-height: 60px;
            padding: 15px;
            border: none;
            border-radius: 4px;
            line-height: 1.5;
            resize: none;
            font-family: inherit;
            background: white;
            overflow: hidden;
            height: auto;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            white-space: pre-wrap;
        }

        .rich-text-editor:focus {
            outline: none;
            background-color: #f8f9fa;
        }

        .rich-text-editor[placeholder]:empty:before {
            content: attr(placeholder);
            color: #6c757d;
            font-style: italic;
        }

        .media-content {
            max-width: 100%;
            border-radius: 6px;
        }

        .media-content img {
            max-width: 100%;
            max-height: 400px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .media-content video {
            max-width: 100%;
            max-height: 400px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .block-controls {
            position: absolute;
            top: -10px;
            right: 10px;
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .block:hover .block-controls {
            opacity: 1;
        }

        .block-controls button {
            width: 30px;
            height: 30px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-move {
            background: #6c757d;
            color: white;
        }

        .btn-remove {
            background: #dc3545;
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #495057;
        }

        .next-btn {
            display: block;
            width: 220px;
            margin: 30px auto 0;
            padding: 12px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
        }

        .next-btn:hover {
            background-color: #2980b9;
        }

        .next-btn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        .media-preview {
            margin-top: 10px;
            text-align: center;
        }

        .media-preview img,
        .media-preview video {
            max-width: 200px;
            max-height: 150px;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .global-text-settings {
            background-color: #e8f4fd;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border: 1px solid #b3d9ff;
        }

        .global-text-settings h3 {
            margin-bottom: 10px;
            color: #2c3e50;
            font-size: 16px;
        }

        .global-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .global-controls label {
            font-weight: 600;
            color: #495057;
        }

        .global-controls select {
            padding: 6px 10px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 14px;
        }

        .word-wrap-handler {
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            white-space: pre-wrap;
        }

        .current-article-info {
            background: #e8f4fd;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
        }

        .current-article-info h3 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .article-meta {
            color: #6c757d;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .existing-media-preview {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #e9ecef;
        }

        .existing-media-preview img,
        .existing-media-preview video {
            max-width: 100%;
            max-height: 200px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
<div class="container">
    <h1 th:text="${isEdit ? '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—å–∏' : 'üìù –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç–∞—Ç—å–∏'}">–†–µ–¥–∞–∫—Ç–æ—Ä —Å—Ç–∞—Ç—å–∏</h1>

    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–π —Å—Ç–∞—Ç—å–µ -->
    <div th:if="${article}" class="current-article-info">
        <h3>–†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–∞—è —Å—Ç–∞—Ç—å—è: <span th:text="${article.title}"></span></h3>
        <p th:text="${article.shortDescription}"></p>
        <div class="article-meta">
            <span>–°—Ç–∞—Ç—É—Å: </span>
            <span th:if="${article.published}" style="color: #28a745;">‚úÖ –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞</span>
            <span th:unless="${article.published}" style="color: #ffc107;">üìù –ß–µ—Ä–Ω–æ–≤–∏–∫</span>
            <span> ‚Ä¢ –ü—Ä–æ—Å–º–æ—Ç—Ä—ã: <span th:text="${article.viewCount}">0</span></span>
            <span> ‚Ä¢ –°–æ–∑–¥–∞–Ω–∞: <span th:text="${#temporals.format(article.createdAt, 'dd.MM.yyyy')}"></span></span>
        </div>
    </div>

    <!-- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ–∫—Å—Ç–∞ -->
    <div class="global-text-settings">
        <h3>‚öôÔ∏è –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ–∫—Å—Ç–∞</h3>
        <div class="global-controls">
            <div>
                <label for="globalFontFamily">–®—Ä–∏—Ñ—Ç:</label>
                <select id="globalFontFamily" onchange="applyGlobalFontFamily()">
                    <option value="'Segoe UI', Tahoma, Geneva, Verdana, sans-serif">Segoe UI</option>
                    <option value="Arial, sans-serif">Arial</option>
                    <option value="'Times New Roman', serif">Times New Roman</option>
                    <option value="Georgia, serif">Georgia</option>
                    <option value="'Courier New', monospace">Courier New</option>
                </select>
            </div>
            <div>
                <label for="globalFontSize">–†–∞–∑–º–µ—Ä:</label>
                <select id="globalFontSize" onchange="applyGlobalFontSize()">
                    <option value="14px">–ú–∞–ª–µ–Ω—å–∫–∏–π</option>
                    <option value="16px" selected>–°—Ä–µ–¥–Ω–∏–π</option>
                    <option value="18px">–ë–æ–ª—å—à–æ–π</option>
                    <option value="20px">–û—á–µ–Ω—å –±–æ–ª—å—à–æ–π</option>
                </select>
            </div>
        </div>
    </div>

    <div class="toolbar">
        <button type="button" id="addTextBtn" class="btn-primary">
            üìù –î–æ–±–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç
        </button>
        <button type="button" id="addMediaBtn" class="btn-primary">
            üñºÔ∏è –î–æ–±–∞–≤–∏—Ç—å –º–µ–¥–∏–∞
        </button>
        <button type="button" id="clearAllBtn" style="background-color: #dc3545; color: white;">
            üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ
        </button>
    </div>

    <div id="blocksContainer" class="blocks-container">
        <div class="empty-state" id="emptyState">
            <h3>–ù–∞—á–Ω–∏—Ç–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å—Ç–∞—Ç—å—é</h3>
            <p>–î–æ–±–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –±–ª–æ–∫–∏ –∏–ª–∏ –º–µ–¥–∏–∞—Ñ–∞–π–ª—ã –∏—Å–ø–æ–ª—å–∑—É—è –∫–Ω–æ–ø–∫–∏ –≤—ã—à–µ</p>
        </div>
    </div>

    <button id="nextBtn" class="next-btn" disabled>
        <span th:text="${isEdit ? 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è' : '–î–∞–ª–µ–µ ‚Üí'}"></span>
    </button>
</div>

<script>
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let currentUserId = null;
    let isEditMode = [[${isEdit}]];
    let currentArticleId = [[${article?.id}]];
    let globalFontFamily = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
    let globalFontSize = "16px";
    let currentEditingBlock = null;

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Ä–µ–≥—É–ª–∏—Ä–æ–≤–∫–∏ –≤—ã—Å–æ—Ç—ã —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –±–ª–æ–∫–∞
    function autoResizeTextBlock(element) {
        const selection = window.getSelection();
        const range = selection.rangeCount > 0 ? selection.getRangeAt(0) : null;
        const currentCursorPosition = range ? range.startOffset : 0;

        element.style.height = 'auto';
        const newHeight = Math.max(element.scrollHeight, 60);
        element.style.height = newHeight + 'px';

        if (range && currentCursorPosition > 0) {
            try {
                const textNode = element.childNodes[0] || element;
                if (textNode.nodeType === Node.TEXT_NODE || element.childNodes.length === 0) {
                    const newRange = document.createRange();
                    newRange.setStart(textNode, Math.min(currentCursorPosition, textNode.length || 0));
                    newRange.collapse(true);
                    selection.removeAllRanges();
                    selection.addRange(newRange);
                }
            } catch (e) {
                console.log('Could not restore cursor position:', e);
            }
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –±–ª–æ–∫–∞
    function addTextBlock(content = '') {
        const editor = document.getElementById('blocksContainer');
        const emptyState = document.getElementById('emptyState');

        hideEmptyState();
        const block = document.createElement('div');
        block.className = 'block text-block';
        block.innerHTML = `
            <div class="block-controls">
                <button type="button" class="btn-move" onclick="moveBlockUp(this)">‚Üë</button>
                <button type="button" class="btn-move" onclick="moveBlockDown(this)">‚Üì</button>
                <button type="button" class="btn-remove" onclick="removeBlock(this)">√ó</button>
            </div>
            <div class="text-formatting-toolbar">
                <button type="button" class="format-btn" onclick="formatText('bold')" title="–ñ–∏—Ä–Ω—ã–π"><b>B</b></button>
                <button type="button" class="format-btn" onclick="formatText('italic')" title="–ö—É—Ä—Å–∏–≤"><i>I</i></button>
                <button type="button" class="format-btn" onclick="formatText('underline')" title="–ü–æ–¥—á–µ—Ä–∫–Ω—É—Ç—ã–π"><u>U</u></button>
                <select onchange="formatText('fontName', this.value)" title="–®—Ä–∏—Ñ—Ç">
                    <option value="">–®—Ä–∏—Ñ—Ç</option>
                    <option value="Arial">Arial</option>
                    <option value="Times New Roman">Times New Roman</option>
                    <option value="Courier New">Courier New</option>
                    <option value="Georgia">Georgia</option>
                </select>
                <input type="color" onchange="formatText('foreColor', this.value)" title="–¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞">
                <select onchange="formatText('fontSize', this.value)" title="–†–∞–∑–º–µ—Ä">
                    <option value="">–†–∞–∑–º–µ—Ä</option>
                    <option value="1">–ú–∞–ª–µ–Ω—å–∫–∏–π</option>
                    <option value="3">–ù–æ—Ä–º–∞–ª—å–Ω—ã–π</option>
                    <option value="5">–ë–æ–ª—å—à–æ–π</option>
                    <option value="7">–û—á–µ–Ω—å –±–æ–ª—å—à–æ–π</option>
                </select>
                <button type="button" class="format-btn" onclick="formatText('justifyLeft')" title="–í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ –ª–µ–≤–æ–º—É –∫—Ä–∞—é">‚¨Ö</button>
                <button type="button" class="format-btn" onclick="formatText('justifyCenter')" title="–í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ —Ü–µ–Ω—Ç—Ä—É">‚Üî</button>
                <button type="button" class="format-btn" onclick="formatText('justifyRight')" title="–í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ –ø—Ä–∞–≤–æ–º—É –∫—Ä–∞—é">‚û°</button>
                <button type="button" class="format-btn" onclick="formatText('justifyFull')" title="–í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ —à–∏—Ä–∏–Ω–µ">‚§¢</button>
            </div>
            <div class="rich-text-editor word-wrap-handler"
                 contenteditable="true"
                 onfocus="setCurrentBlock(this)"
                 oninput="autoResizeTextBlock(this)"
                 placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç..."
                 style="font-family: ${globalFontFamily}; font-size: ${globalFontSize};">
                ${content}
            </div>
        `;
        editor.appendChild(block);

        const newEditor = block.querySelector('.rich-text-editor');
        if (newEditor) {
            setTimeout(() => autoResizeTextBlock(newEditor), 10);
        }

        updateNextButton();
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–µ–¥–∏–∞ –±–ª–æ–∫–∞
    function addMediaBlock(filePath = '') {
        const editor = document.getElementById('blocksContainer');

        hideEmptyState();
        const block = document.createElement('div');
        block.className = 'block media-block';

        let existingMediaHTML = '';
        if (filePath) {
            const isImage = filePath.match(/\.(jpg|jpeg|png|gif|webp)$/i);
            const isVideo = filePath.match(/\.(mp4|webm|ogg|mov)$/i);
            const isAudio = filePath.match(/\.(mp3|wav|ogg)$/i);

            if (isImage) {
                existingMediaHTML = `
                    <div class="existing-media-preview">
                        <p><strong>–°—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ–∞–π–ª:</strong> ${filePath}</p>
                        <img src="/uploads/${filePath}" alt="${filePath}"
                             onerror="this.style.display='none';">
                    </div>
                `;
            } else if (isVideo) {
                existingMediaHTML = `
                    <div class="existing-media-preview">
                        <p><strong>–°—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ–∞–π–ª:</strong> ${filePath}</p>
                        <video src="/uploads/${filePath}" controls
                               onerror="this.style.display='none';">
                            –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ.
                        </video>
                    </div>
                `;
            } else if (isAudio) {
                existingMediaHTML = `
                    <div class="existing-media-preview">
                        <p><strong>–°—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ–∞–π–ª:</strong> ${filePath}</p>
                        <audio src="/uploads/${filePath}" controls
                               onerror="this.style.display='none';">
                            –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞—É–¥–∏–æ.
                        </audio>
                    </div>
                `;
            } else {
                existingMediaHTML = `
                    <div class="existing-media-preview">
                        <p><strong>–§–∞–π–ª:</strong> ${filePath}</p>
                        <p><em>–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø —Ñ–∞–π–ª–∞ –∏–ª–∏ —Ñ–∞–π–ª –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω</em></p>
                    </div>
                `;
            }
        }

        block.innerHTML = `
            <div class="block-controls">
                <button type="button" class="btn-move" onclick="moveBlockUp(this)">‚Üë</button>
                <button type="button" class="btn-move" onclick="moveBlockDown(this)">‚Üì</button>
                <button type="button" class="btn-remove" onclick="removeBlock(this)">√ó</button>
            </div>
            <div style="margin-bottom: 15px;">
                <label><strong>–í—ã–±–µ—Ä–∏—Ç–µ –º–µ–¥–∏–∞—Ñ–∞–π–ª:</strong></label>
                <input type="file" accept="image/*,video/*,audio/*"
                       onchange="previewMedia(this)" style="margin-top: 8px;">
            </div>
            <div style="margin-bottom: 15px;">
                <label><strong>–ò–ª–∏ —É–∫–∞–∂–∏—Ç–µ –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É:</strong></label>
                <input type="text" placeholder="/uploads/filename.jpg"
                       style="width: 100%; padding: 8px; margin-top: 8px; border: 1px solid #ddd; border-radius: 4px;"
                       value="${filePath}">
            </div>
            ${existingMediaHTML}
            <div class="media-preview" style="display: none;"></div>
        `;
        editor.appendChild(block);
        updateNextButton();
    }

    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –º–µ–¥–∏–∞
    function previewMedia(input) {
        const file = input.files[0];
        const preview = input.closest('.media-block').querySelector('.media-preview');

        if (file) {
            const url = URL.createObjectURL(file);
            preview.innerHTML = '';

            if (file.type.startsWith('image/')) {
                const img = document.createElement('img');
                img.src = url;
                preview.appendChild(img);
            } else if (file.type.startsWith('video/')) {
                const video = document.createElement('video');
                video.src = url;
                video.controls = true;
                preview.appendChild(video);
            } else if (file.type.startsWith('audio/')) {
                const audio = document.createElement('audio');
                audio.src = url;
                audio.controls = true;
                preview.appendChild(audio);
            }

            preview.style.display = 'block';
        } else {
            preview.style.display = 'none';
        }
    }

    // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –±–ª–æ–∫–∞
    function removeBlock(button) {
        const block = button.closest('.block');
        block.remove();
        updateNextButton();
        checkEmptyState();
    }

    // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –±–ª–æ–∫–∞ –≤–≤–µ—Ä—Ö
    function moveBlockUp(button) {
        const block = button.closest('.block');
        const prevBlock = block.previousElementSibling;
        if (prevBlock) {
            block.parentNode.insertBefore(block, prevBlock);
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –±–ª–æ–∫–∞ –≤–Ω–∏–∑
    function moveBlockDown(button) {
        const block = button.closest('.block');
        const nextBlock = block.nextElementSibling;
        if (nextBlock) {
            block.parentNode.insertBefore(nextBlock, block);
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ –≤—Å–µ—Ö –±–ª–æ–∫–æ–≤
    function clearAllBlocks() {
        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –±–ª–æ–∫–∏?')) {
            const editor = document.getElementById('blocksContainer');
            editor.innerHTML = '';
            showEmptyState();
            updateNextButton();
        }
    }

    // –§—É–Ω–∫—Ü–∏—è —Å–∫—Ä—ã—Ç–∏—è –ø—É—Å—Ç–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    function hideEmptyState() {
        const emptyState = document.getElementById('emptyState');
        emptyState.style.display = 'none';
    }

    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –ø—É—Å—Ç–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    function showEmptyState() {
        const emptyState = document.getElementById('emptyState');
        emptyState.style.display = 'block';
    }

    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—É—Å—Ç–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    function checkEmptyState() {
        const editor = document.getElementById('blocksContainer');
        const emptyState = document.getElementById('emptyState');
        const blocks = editor.querySelectorAll('.block');
        if (blocks.length === 0) {
            showEmptyState();
        } else {
            hideEmptyState();
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–∫–∏ "–î–∞–ª–µ–µ"
    function updateNextButton() {
        const editor = document.getElementById('blocksContainer');
        const nextBtn = document.getElementById('nextBtn');
        const blocks = editor.querySelectorAll('.block');
        const hasContent = blocks.length > 0;
        nextBtn.disabled = !hasContent;
    }

    // –§—É–Ω–∫—Ü–∏–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞
    function setCurrentBlock(element) {
        currentEditingBlock = element;
    }

    function formatText(command, value = null) {
        if (!currentEditingBlock) {
            alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–π –±–ª–æ–∫ –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
            return;
        }

        currentEditingBlock.focus();
        document.execCommand(command, false, value);
        autoResizeTextBlock(currentEditingBlock);
    }

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ–∫—Å—Ç–∞
    function applyGlobalFontFamily() {
        globalFontFamily = document.getElementById('globalFontFamily').value;
        applyGlobalTextSettings();
    }

    function applyGlobalFontSize() {
        globalFontSize = document.getElementById('globalFontSize').value;
        applyGlobalTextSettings();
    }

    function applyGlobalTextSettings() {
        const textBlocks = document.querySelectorAll('.rich-text-editor');
        textBlocks.forEach(block => {
            block.style.fontFamily = globalFontFamily;
            block.style.fontSize = globalFontSize;
        });
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
    function getEditorContent() {
        const editor = document.getElementById('blocksContainer');
        const blocks = [];
        const blockElements = editor.querySelectorAll('.block');

        blockElements.forEach((block, index) => {
            const blockType = block.classList.contains('text-block') ? 'text' : 'media';

            let content = '';
            let file = null;

            if (blockType === 'text') {
                const richEditor = block.querySelector('.rich-text-editor');
                if (richEditor) {
                    content = richEditor.innerHTML;
                }
            } else if (blockType === 'media') {
                const fileInput = block.querySelector('input[type="file"]');
                const pathInput = block.querySelector('input[type="text"]');

                if (fileInput && fileInput.files.length > 0) {
                    file = fileInput.files[0];
                    content = file.name;
                } else if (pathInput && pathInput.value.trim()) {
                    content = pathInput.value.trim();
                } else {
                    // –î–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –º–µ–¥–∏–∞-–±–ª–æ–∫–æ–≤
                    const existingMedia = block.querySelector('.existing-media-preview');
                    if (existingMedia) {
                        const mediaText = existingMedia.querySelector('p');
                        if (mediaText) {
                            content = mediaText.textContent.replace('–§–∞–π–ª: ', '').trim();
                        }
                    }
                }
            }

            const blockData = {
                type: blockType,
                content: content.trim(),
                order: index
            };

            if (file) {
                blockData.file = file;
            }

            blocks.push(blockData);
        });

        return blocks;
    }

    // –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É
    function goToNextStep() {
        const blocks = getEditorContent();

        if (blocks.length === 0) {
            alert('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –±–ª–æ–∫ –≤ —Å—Ç–∞—Ç—å—é');
            return;
        }

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –±–ª–æ–∫–∏ –≤ localStorage –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —à–∞–≥–∞
        localStorage.setItem('articleBlocks', JSON.stringify(blocks));

        if (isEditMode) {
            // –í —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ä–∞–∑—É —Å–æ—Ö—Ä–∞–Ω—è–µ–º
            saveArticleChanges();
        } else {
            // –í —Ä–µ–∂–∏–º–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É
            window.location.href = '/articles/editor2/metadata';
        }
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å—Ç–∞—Ç—å–∏
    async function saveArticleChanges() {
        const blocks = getEditorContent();

        // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —É –≤—Å–µ—Ö –±–ª–æ–∫–æ–≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫
        blocks.forEach((block, index) => {
            block.order = index;
        });

        const title = document.querySelector('input[name="title"]')?.value || "–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç–∞—Ç—å–∏";
        const shortDescription = document.querySelector('textarea[name="shortDescription"]')?.value || "–û–ø–∏—Å–∞–Ω–∏–µ —Å—Ç–∞—Ç—å–∏";

        try {
            const response = await fetch(`/articles/update/${currentArticleId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    'title': title,
                    'shortDescription': shortDescription,
                    'blocks': JSON.stringify(blocks),
                    'isPublished': 'false',
                    'tags': ''
                })
            });

            const result = await response.json();

            if (result.success) {
                alert('–°—Ç–∞—Ç—å—è —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!');
                window.location.href = `/articles/${currentArticleId}`;
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—å–∏: ' + result.error);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞:', error);
            alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + error.message);
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –±–ª–æ–∫–æ–≤
    function loadExistingBlocks(blocks) {
        hideEmptyState();
        console.log('Loading blocks:', blocks);

        if (blocks && blocks.length > 0) {
            blocks.forEach(block => {
                console.log('Loading block:', block);
                if (block.type === 'text') {
                    addTextBlock(block.content);
                } else if (block.type === 'media') {
                    addMediaBlock(block.content);
                }
            });
        } else {
            // –ï—Å–ª–∏ –±–ª–æ–∫–æ–≤ –Ω–µ—Ç, –¥–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç–æ–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –±–ª–æ–∫
            addTextBlock();
        }
        updateNextButton();
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é
        fetch('/secured/user')
            .then(response => {
                if (!response.ok) {
                    window.location.href = '/auth/login';
                }
                return response.text();
            })
            .then(username => {
                console.log('Authenticated as:', username);
            })
            .catch(error => {
                console.error('Auth check failed:', error);
                window.location.href = '/auth/login';
            });

        // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
        document.getElementById('addTextBtn').addEventListener('click', () => addTextBlock());
        document.getElementById('addMediaBtn').addEventListener('click', () => addMediaBlock());
        document.getElementById('clearAllBtn').addEventListener('click', clearAllBlocks);
        document.getElementById('nextBtn').addEventListener('click', goToNextStep);

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –±–ª–æ–∫–æ–≤ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
        if (isEditMode && window.articleBlocks) {
            console.log('Loading existing blocks:', window.articleBlocks);
            loadExistingBlocks(window.articleBlocks);
        } else if (!isEditMode) {
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –±–ª–æ–∫ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–π —Å—Ç–∞—Ç—å–∏
            addTextBlock();
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        checkEmptyState();
        updateNextButton();
    });

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å—Ç–∞—Ç—å–∏
    async function saveArticleChanges() {
        const blocks = getEditorContent();

        // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —É –≤—Å–µ—Ö –±–ª–æ–∫–æ–≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫
        blocks.forEach((block, index) => {
            block.order = index;
        });

        const title = document.querySelector('input[name="title"]')?.value || "–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç–∞—Ç—å–∏";
        const shortDescription = document.querySelector('textarea[name="shortDescription"]')?.value || "–û–ø–∏—Å–∞–Ω–∏–µ —Å—Ç–∞—Ç—å–∏";
        const tagsInput = document.querySelector('input[name="tags"]');
        const tagsText = tagsInput ? tagsInput.value : '';
        const tags = extractTagsFromText(tagsText);

        try {
            const response = await fetch(`/articles/update/${currentArticleId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    'title': title,
                    'shortDescription': shortDescription,
                    'blocks': JSON.stringify(blocks),
                    'isPublished': 'false',
                    'tags': tags.join(',')
                })
            });

            const result = await response.json();

            if (result.success) {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ sessionStorage –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –Ω–∞ create-article
                sessionStorage.setItem('editArticleData', JSON.stringify({
                    title: title,
                    shortDescription: shortDescription,
                    blocks: blocks,
                    tags: tags,
                    isPublished: false,
                    articleId: currentArticleId
                }));

                // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É create-article
                window.location.href = result.redirectUrl || '/articles/create-form2?edit=true&articleId=' + currentArticleId;
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—å–∏: ' + result.error);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞:', error);
            alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + error.message);
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ç–µ–≥–æ–≤ –∏–∑ —Ç–µ–∫—Å—Ç–∞
    function extractTagsFromText(text) {
        if (!text) return [];
        const tagPattern = /#(\w+)/g;
        const matches = text.match(tagPattern);
        if (!matches) return [];
        return matches.map(match => match.substring(1)).slice(0, 3);
    }
</script>

<!-- –ü–µ—Ä–µ–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ç—å–∏ –≤ JavaScript -->
<script th:inline="javascript">
    /*<![CDATA[*/
    window.articleBlocks = /*[[${article?.blocks}]]*/ [];
    /*]]>*/
</script>
</body>
</html>